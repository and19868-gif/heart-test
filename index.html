<script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwPYLcEmyspm5IeGi1Qg4lZgsJqNStwrLYfVVA_IfQtk74k-ii-enUBu93Syl9T5PQ/exec";
        const urlParams = new URLSearchParams(window.location.search);
        const clinicSource = urlParams.get('clinic') || "官網/未註明";

        let realName = "", userAge = 0, userId = "訪客(未授權)"; // 預設為訪客
        let questionList = [], currentIndex = 0, userAnswers = [];

        // --- 修正後的 LIFF 初始化邏輯 ---
        liff.init({ liffId: "2009061399-LVES2gnp" }).then(() => {
            if (liff.isLoggedIn()) {
                liff.getProfile()
                    .then(p => { 
                        userId = p.userId; 
                    })
                    .catch(err => {
                        // 使用者登入 LINE 但拒絕提供個人檔案授權
                        userId = "隱私授權取消";
                        console.log("病患拒絕個人檔案授權，以匿名方式繼續");
                    });
            } else {
                // 重點修正：如果沒登入，不要執行 liff.login()
                // 這樣病患在按「取消」授權後，才能停留在原頁面填寫問卷
                userId = "非LINE環境/拒絕登入";
                console.log("尚未登入 LINE，進入匿名填寫模式");
            }
        }).catch((err) => {
            console.error("LIFF 初始化失敗", err);
            userId = "LIFF初始化失敗";
        });

        function startQuiz() {
            realName = document.getElementById('input-name').value.trim();
            const year = document.getElementById('input-year').value.trim();
            if(!realName || !year) return alert("請完整填寫姓名與出生年份");
            
            userAge = new Date().getFullYear() - (parseInt(year) + 1911);
            
            // 點擊開始後先將按鈕文字改變，避免重複點擊
            const startBtn = document.querySelector('.start-btn');
            startBtn.innerText = "載入中...";
            startBtn.disabled = true;
            
            fetch(API_URL).then(res => res.json()).then(data => {
                questionList = data;
                document.getElementById('start-page').style.display = "none";
                document.getElementById('quiz-page').style.display = "block";
                showQuestion();
            }).catch(err => {
                alert("題目載入失敗，請確認網路連線。");
                startBtn.innerText = "開始檢測";
                startBtn.disabled = false;
            });
        }

        function showQuestion() {
            const q = questionList[currentIndex];
            document.getElementById('q-image').src = q.img || "https://and19868-gif.github.io/heart-test/cover.jpg";
            document.getElementById('q-text').innerText = q.text;
            document.getElementById('progress').style.width = ((currentIndex + 1) / questionList.length * 100) + "%";
        }

        function handleAnswer(val) {
            userAnswers.push(val);
            if (currentIndex < questionList.length - 1) {
                currentIndex++;
                showQuestion();
            } else {
                submitResult();
            }
        }

        function submitResult() {
            const score = userAnswers.filter(v => v).length;
            let level, color, desc;

            if (score <= 1) {
                level = "第一級：綠色警戒"; color = "#28a745"; 
                desc = "【與生理年齡相符】低風險族群，但現代人生活節奏快，隱形壓力不可掉以輕心。建議維持每年一次定期健康檢查。";
            } else if (score <= 4) {
                level = "第二級：黃色警戒"; color = "#f39c12"; 
                desc = "【老化預估 +10 歲】血管發出疲勞警訊！長期代謝緩慢正在加速血管硬化。建議進階抽血檢測與內臟脂肪評估。";
            } else {
                level = "第三級：紅色警報"; color = "#dc3545"; 
                desc = "【老化預估 +20 歲】危險！血管健康已在臨界點！血管老化可能已超出負荷，發生疾病意外風險顯著增加。立即預約掛號就診。";
            }

            document.getElementById('quiz-page').style.display = "none";
            const resArea = document.getElementById('result-page');
            resArea.style.display = "block";
            resArea.innerHTML = `
                <div class="result-card" style="border-color:${color}; background-color:${color}11;">
                    <h2 style="color:${color}">${level}</h2>
                    <p><b>受測者：</b>${realName} (${userAge}歲)</p>
                    <p>${desc}</p>
                    <button class="start-btn" onclick="liff.closeWindow()">填寫完成，關閉視窗</button>
                </div>
            `;

            // 將結果傳回 Google Sheets
            fetch(API_URL, {
                method: "POST",
                mode: 'no-cors',
                body: JSON.stringify({ userId, realName, userAge, score, level, details: userAnswers, clinic: clinicSource })
            });
        }
    </script>