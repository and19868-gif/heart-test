<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>血管年齡自測系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .cover-img { width: 100%; border-radius: 15px; margin-bottom: 20px; display: block; }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .info-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .start-btn { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .q-box { padding: 15px; border-bottom: 1px solid #edf2f7; display: flex; flex-direction: column; cursor: pointer; margin-bottom: 15px; background: #fff; border-radius: 12px; }
        .q-img { width: 100%; max-height: 250px; object-fit: cover; border-radius: 10px; margin-bottom: 12px; }
        .q-text-row { display: flex; align-items: flex-start; }
        .q-text-row input { width: 22px; height: 22px; margin-right: 12px; flex-shrink: 0; }
        .btn { background: #4A90E2; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 25px; cursor: pointer; }
        #quiz-area, #result { display: none; }
        .result-card { padding: 20px; border-radius: 15px; text-align: left; line-height: 1.6; border: 2px solid; }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://and19868-gif.github.io/heart-test/cover.jpg" id="mainCover" class="cover-img">
        <h2 id="mainTitle">血管健康自測量表</h2>

        <div id="user-info">
            <p style="color: #666; text-align: center;">請填寫基本資料開始評估</p>
            <label>您的姓名：</label>
            <input type="text" id="input-name" class="info-input" placeholder="請輸入姓名">
            <label>出生年 (民國)：</label>
            <input type="number" id="input-year" class="info-input" placeholder="例如：75">
            <button class="start-btn" onclick="startQuiz()">開始測驗</button>
        </div>

        <div id="quiz-area">
            <div id="quiz">載入中...</div>
            <button id="submitBtn" class="btn" onclick="calculate()">提交分析結果</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwPYLcEmyspm5IeGi1Qg4lZgsJqNStwrLYfVVA_IfQtk74k-ii-enUBu93Syl9T5PQ/exec"; 
        const urlParams = new URLSearchParams(window.location.search);
        const clinicSource = urlParams.get('clinic') || "官網/未註明";

        let realName = "", userId = "未知ID", userAge = 0, questionList = [];

        liff.init({ liffId: "2009061399-LVES2gnp" }).then(() => {
            if (liff.isLoggedIn()) {
                liff.getProfile().then(p => { userId = p.userId; });
            } else { liff.login(); }
        });

        function startQuiz() {
            const nameInput = document.getElementById('input-name').value;
            const yearInput = document.getElementById('input-year').value;
            if (!nameInput || !yearInput) { alert("請填寫資料"); return; }
            realName = nameInput;
            userAge = new Date().getFullYear() - (parseInt(yearInput) + 1911);
            document.getElementById('user-info').style.display = "none";
            document.getElementById('quiz-area').style.display = "block";
            fetchQuestions();
        }

        function fetchQuestions() {
            fetch(API_URL).then(res => res.json()).then(data => {
                questionList = data;
                const container = document.getElementById('quiz');
                container.innerHTML = "";
                data.forEach((q, i) => {
                    const imgTag = q.img ? `<img src="${q.img}" class="q-img">` : "";
                    container.innerHTML += `
                        <div class="q-box" onclick="toggleCheck(${i})">
                            ${imgTag}
                            <div class="q-text-row">
                                <input type="checkbox" class="q" id="q${i}" onclick="event.stopPropagation()">
                                <label style="cursor:pointer">${q.text}</label>
                            </div>
                        </div>`;
                });
            });
        }

        function toggleCheck(i) {
            const cb = document.getElementById('q'+i);
            if(cb) cb.checked = !cb.checked;
        }

        function calculate() {
            const checks = document.querySelectorAll('.q');
            let score = 0, details = [];
            checks.forEach(c => { score += c.checked ? 1 : 0; details.push(c.checked); });

            let level, color, desc;

            if (score <= 1) {
                level = "第一級：綠色警戒"; color = "#28a745"; 
                desc = "【與生理年齡相符】低風險族群，但現代人生活節奏快，隱形壓力不可掉以輕心。建議維持每年一次定期健康檢查。";
            } else if (score <= 4) {
                level = "第二級：黃色警戒"; color = "#f39c12"; 
                desc = "【老化預估 +10 歲】血管發出疲勞警訊！ 長期代謝緩慢正在加速血管硬化。建議進階抽血檢測與內臟脂肪評估。";
            } else {
                level = "第三級：紅色警報"; color = "#dc3545"; 
                desc = "【老化預估 +20 歲】危險！血管健康已在臨界點！血管老化可能已超出負荷，發生疾病意外風險顯著增加。立即預約掛號就診，考慮藥物控制。";
            }

            document.getElementById('mainCover').style.display = "none";
            document.getElementById('mainTitle').style.display = "none";
            document.getElementById('quiz-area').style.display = "none";
            
            const resDiv = document.getElementById('result');
            resDiv.style.display = "block";
            resDiv.innerHTML = `
                <div class="result-card" style="border-color:${color}; background-color:${color}11;">
                    <h2 style="color:${color}; text-align:center;">${level}</h2>
                    <p><strong>受測者：</strong>${realName} (${userAge} 歲)</p>
                    <p>${desc}</p>
                    <button onclick="liff.closeWindow()" style="background:${color}; color:white; padding:15px; width:100%; border:none; border-radius:10px; margin-top:20px; font-weight:bold; cursor:pointer; font-size:16px;">確認並關閉</button>
                </div>
            `;

            fetch(API_URL, {
                method: "POST",
                mode: 'no-cors',
                body: JSON.stringify({ userId, realName, userAge, score, level, details, clinic: clinicSource })
            });
        }
    </script>
</body>
</html>