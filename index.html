<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€ç®¡å¹´é½¡è‡ªæ¸¬ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .cover-img { width: 100%; border-radius: 15px; margin-bottom: 20px; display: block; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        .info-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .start-btn { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .q-box { padding: 15px; border-bottom: 1px solid #edf2f7; display: flex; flex-direction: column; cursor: pointer; margin-bottom: 15px; background: #fff; border-radius: 12px; }
        .q-img { width: 100%; max-height: 250px; object-fit: cover; border-radius: 10px; margin-bottom: 12px; }
        .q-text-row { display: flex; align-items: flex-start; }
        .q-text-row input { width: 22px; height: 22px; margin-right: 12px; flex-shrink: 0; }
        .btn { background: #4A90E2; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; margin-top: 25px; cursor: pointer; }
        #quiz-area, #result { display: none; }
        .result-card { padding: 20px; border-radius: 15px; text-align: left; line-height: 1.6; border: 2px solid; }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://and19868-gif.github.io/heart-test/cover.jpg" id="mainCover" class="cover-img">
        <h2 id="mainTitle">è¡€ç®¡å¥åº·è‡ªæ¸¬é‡è¡¨</h2>

        <div id="user-info">
            <p style="color: #666; text-align: center;">è«‹å¡«å¯«åŸºæœ¬è³‡æ–™é–‹å§‹è©•ä¼°</p>
            <label>æ‚¨çš„å§“åï¼š</label>
            <input type="text" id="input-name" class="info-input" placeholder="è«‹è¼¸å…¥å§“å">
            <label>å‡ºç”Ÿå¹´ (æ°‘åœ‹)ï¼š</label>
            <input type="number" id="input-year" class="info-input" placeholder="ä¾‹å¦‚ï¼š75" min="1" max="120">
            <button class="start-btn" onclick="startQuiz()">é–‹å§‹æ¸¬é©—</button>
        </div>

        <div id="quiz-area">
            <div id="quiz">æ­£åœ¨åŒæ­¥è¨ºæ‰€è³‡æ–™...</div>
            <button id="submitBtn" class="btn" onclick="calculate()">æäº¤åˆ†æçµæœ</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwPYLcEmyspm5IeGi1Qg4lZgsJqNStwrLYfVVA_IfQtk74k-ii-enUBu93Syl9T5PQ/exec"; 
        const urlParams = new URLSearchParams(window.location.search);
        const clinicSource = urlParams.get('clinic') || "å®˜ç¶²/æœªè¨»æ˜";

        let realName = "", userId = "æœªçŸ¥ID", userAge = 0, questionList = [];

        liff.init({ liffId: "2009061399-LVES2gnp" }).then(() => {
            if (liff.isLoggedIn()) {
                liff.getProfile().then(p => { userId = p.userId; });
            } else { liff.login(); }
        });

        function startQuiz() {
            const nameInput = document.getElementById('input-name').value.trim();
            const yearInput = document.getElementById('input-year').value.trim();

            if (!nameInput || !yearInput) {
                alert("è«‹å¡«å¯«å§“åèˆ‡å‡ºç”Ÿå¹´ä»½");
                return;
            }

            realName = nameInput;
            const currentYear = new Date().getFullYear();
            userAge = currentYear - (parseInt(yearInput) + 1911);

            document.getElementById('user-info').style.display = "none";
            document.getElementById('quiz-area').style.display = "block";
            fetchQuestions();
        }

        function fetchQuestions() {
            fetch(API_URL).then(res => res.json()).then(data => {
                questionList = data;
                const container = document.getElementById('quiz');
                container.innerHTML = "";
                data.forEach((q, i) => {
                    const imgTag = q.img ? `<img src="${q.img}" class="q-img">` : "";
                    container.innerHTML += `
                        <div class="q-box" onclick="toggleCheck(${i})">
                            ${imgTag}
                            <div class="q-text-row">
                                <input type="checkbox" class="q" id="q${i}" onclick="event.stopPropagation()">
                                <label style="cursor:pointer">${q.text}</label>
                            </div>
                        </div>`;
                });
            }).catch(err => {
                document.getElementById('quiz').innerHTML = "è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API è¨­å®šã€‚";
            });
        }

        function toggleCheck(i) {
            const cb = document.getElementById('q'+i);
            if(cb) cb.checked = !cb.checked;
        }

        function calculate() {
            const checks = document.querySelectorAll('.q');
            let score = 0, details = [];
            checks.forEach(c => { score += c.checked ? 1 : 0; details.push(c.checked); });

            let level, color, ageDesc, content, suggest;

            if (score <= 1) {
                level = "ç¬¬ä¸€ç´šï¼šç¶ è‰²è­¦æˆ’"; color = "#28a745"; 
                ageDesc = "èˆ‡ç”Ÿç†å¹´é½¡ç›¸ç¬¦";
                content = "ä½é¢¨éšªæ—ç¾¤ï¼Œä½†ç¾ä»£äººç”Ÿæ´»ç¯€å¥å¿«ï¼Œéš±å½¢å£“åŠ›ä¸å¯æ‰ä»¥è¼•å¿ƒã€‚";
                suggest = "å»ºè­°ç¶­æŒæ¯å¹´ä¸€æ¬¡å®šæœŸå¥åº·æª¢æŸ¥ã€‚";
            } else if (score <= 4) {
                level = "ç¬¬äºŒç´šï¼šé»ƒè‰²è­¦æˆ’"; color = "#f39c12"; 
                ageDesc = "è€åŒ–é ä¼° +10 æ­²";
                content = "è¡€ç®¡ç™¼å‡ºç–²å‹è­¦è¨Šï¼ é•·æœŸä»£è¬ç·©æ…¢æ­£åœ¨åŠ é€Ÿè¡€ç®¡ç¡¬åŒ–ã€‚";
                suggest = "å»ºè­°é€²éšæŠ½è¡€æª¢æ¸¬èˆ‡å…§è‡Ÿè„‚è‚ªè©•ä¼°ã€‚";
            } else {
                level = "ç¬¬ä¸‰ç´šï¼šç´…è‰²è­¦å ±"; color = "#dc3545"; 
                ageDesc = "è€åŒ–é ä¼° +20 æ­²";
                content = "å±éšªï¼è¡€ç®¡å¥åº·å·²åœ¨è‡¨ç•Œé»ï¼ç™¼ç”Ÿç–¾ç—…æ„å¤–é¢¨éšªé¡¯è‘—å¢åŠ ã€‚";
                suggest = "ç«‹å³é ç´„æ›è™Ÿå°±è¨ºï¼Œè€ƒæ…®è—¥ç‰©æ§åˆ¶ã€‚";
            }

            document.getElementById('mainCover').style.display = "none";
            document.getElementById('mainTitle').style.display = "none";
            document.getElementById('quiz-area').style.display = "none";
            
            const resDiv = document.getElementById('result');
            resDiv.style.display = "block";
            resDiv.innerHTML = `
                <div class="result-card" style="border-color:${color}; background-color:${color}11;">
                    <h2 style="color:${color}; text-align:center;">${level}</h2>
                    <p><strong>å—æ¸¬è€…ï¼š</strong>${realName} (${userAge} æ­²)</p>
                    <p><strong>è©•ä¼°çµæœï¼š</strong>ã€${ageDesc}ã€‘</p>
                    <p>${content}</p>
                    <hr style="border:0; border-top:1px solid ${color}44; margin: 15px 0;">
                    <p><strong>ğŸ’¡ å»ºè­°ï¼š</strong>${suggest}</p>
                    <button onclick="liff.closeWindow()" style="background:${color}; color:white; padding:15px; width:100%; border:none; border-radius:10px; margin-top:20px; font-weight:bold; cursor:pointer; font-size:16px;">ç¢ºèªä¸¦é—œé–‰è¦–çª—</button>
                </div>
            `;

            fetch(API_URL, {
                method: "POST",
                mode: 'no-cors',
                body: JSON.stringify({
                    userId, 
                    realName,
                    userAge,
                    score, 
                    level, 
                    details, 
                    clinic: clinicSource
                })
            });
        }
    </script>
</body>
</html>